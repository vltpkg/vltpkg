---
description: Registry (vsr) development patterns and architecture
globs: src/vsr/src/**/*,src/vsr/test/**/*
alwaysApply: false
---
# Registry Development (src/vsr/)

npm-compatible registry on Cloudflare Workers (Hono, D1, R2). Multi-upstream, stale-while-revalidate caching. Security audit endpoints are placeholders today (Socket.dev planned for v1.x).

## Architecture

- **Routing order matters**: upstream routes (`/:upstream/...`) validate + `c.set('upstream', upstream)` before local package routes (`/:pkg...`). Final `/*` is static assets fallback.
- **Upstream config**: `env.ORIGIN_CONFIG` (worker env) resolved via `getUpstreamConfig(upstream, c)` (`src/utils/upstream.ts`)
- **Proxy mode**: `PROXY=true` → prefer local DB/R2, then fallback upstream (default via `getDefaultUpstream()`)

## Not Implemented Endpoints

Avoid silent stubs. If an endpoint isn’t implemented yet, return an explicit 501 + docstring (see `src/routes/misc.ts` `auditRoute`).

## Package Name Extraction

For upstream routes, extract from path since route params aren't available. Handle both scoped (`@scope/pkg`) and unscoped. Check against RESERVED_ROUTES.

## DB Patterns

- Packages: name, tags (dist-tags), lastUpdated. Versions: `package@version` format
- Proxy packages: `source='proxy'` prevents local operations
- Cache: `getCachedPackageWithRefresh` (short TTL), `getCachedVersionWithRefresh` (longer TTL)
- Background refresh via `c.executionCtx.waitUntil()`

## Key Patterns

- **Slim manifests**: `slimManifest(manifest, context, c)` in `src/utils/packages.ts`
- **Tarball URLs**: local uses `${c.env.URL}/${createFile({ pkg, version })}`; upstream rewrites to `/${upstream}/${pkg}/-/<file>.tgz`
- **Cache headers**: manifests `public, max-age=300`; tarballs `public, max-age=31536000`

## Dev Commands

- `vlr serve:build` — build + run `dist/bin/vsr.js --debug`
- `vlr serve:watch` — chokidar watch: rebuild + restart
- `vlr deploy` — build + `wrangler deploy`
- `vlr db:setup` / `vlr db:studio` (port 4985)
- `vlr test`, `vlr snap`, `vlr typecheck`

## Key Files

`src/index.ts` (router), `src/routes/packages.ts`, `src/routes/misc.ts`, `src/utils/cache.ts`, `src/utils/upstream.ts`, `src/utils/packages.ts`, `config.ts`
