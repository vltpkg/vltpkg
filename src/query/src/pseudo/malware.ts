import { error } from '@vltpkg/error-cause'
import {
  asPostcssNodeWithChildren,
  asStringNode,
  asTagNode,
  isStringNode,
  isTagNode,
} from '../types.ts'
import type { ParserState, PostcssNode } from '../types.ts'
import { removeNode, removeQuotes } from './helpers.ts'

export type MalwareKinds =
  | '0'
  | '1'
  | '2'
  | '3'
  | 'critical'
  | 'high'
  | 'medium'
  | 'low'
  | undefined

export type MalwareAlertTypes =
  | 'malware'
  | 'gptMalware'
  | 'gptSecurity'
  | 'gptAnomaly'
  | undefined

const kindsMap = new Map<MalwareKinds, MalwareAlertTypes>([
  ['critical', 'malware'],
  ['high', 'gptMalware'],
  ['medium', 'gptSecurity'],
  ['low', 'gptAnomaly'],
  ['0', 'malware'],
  ['1', 'gptMalware'],
  ['2', 'gptSecurity'],
  ['3', 'gptAnomaly'],
])
const kinds = new Set(kindsMap.keys())

export const isMalwareKind = (
  value?: string,
): value is MalwareKinds => kinds.has(value as MalwareKinds)

export const asMalwareKind = (value?: string): MalwareKinds => {
  if (!isMalwareKind(value)) {
    throw error('Expected a valid malware kind', {
      found: value,
      validOptions: Array.from(kinds),
    })
  }
  return value
}

export const parseInternals = (
  nodes: PostcssNode[],
): { kind: MalwareKinds } => {
  let kind: MalwareKinds

  if (isStringNode(asPostcssNodeWithChildren(nodes[0]).nodes[0])) {
    kind = asMalwareKind(
      removeQuotes(
        asStringNode(asPostcssNodeWithChildren(nodes[0]).nodes[0])
          .value,
      ),
    )
  } else if (
    isTagNode(asPostcssNodeWithChildren(nodes[0]).nodes[0])
  ) {
    kind = asMalwareKind(
      asTagNode(asPostcssNodeWithChildren(nodes[0]).nodes[0]).value,
    )
  }

  return { kind }
}

export const malware = async (state: ParserState) => {
  if (!state.securityArchive) {
    throw new Error(
      'Missing security archive while trying to parse ' +
        'the :malware security selector',
    )
  }

  let internals
  try {
    internals = parseInternals(
      asPostcssNodeWithChildren(state.current).nodes,
    )
  } catch (err) {
    throw error('Failed to parse :malware selector', { cause: err })
  }

  const { kind } = internals
  const alertName = kindsMap.get(kind)
  for (const node of state.partial.nodes) {
    const report = state.securityArchive.get(node.id)
    const exclude = !report?.alerts.some(
      alert => alert.type === alertName,
    )
    if (exclude) {
      removeNode(state, node)
    }
  }

  return state
}
