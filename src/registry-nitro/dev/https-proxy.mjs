#!/usr/bin/env node

import httpProxy from 'http-proxy'
import https from 'node:https'

const PROXY_PORT = process.env.HTTPS_PORT || 3001
const TARGET_PORT = process.env.TARGET_PORT || 3000
const TARGET_HOST = process.env.TARGET_HOST || 'localhost'

const CERT = `-----BEGIN CERTIFICATE-----
MIIFjzCCA3egAwIBAgIUIo79rpCSZGiIRh9j5eBxLhEWsVkwDQYJKoZIhvcNAQEL
BQAwVzELMAkGA1UEBhMCVVMxDjAMBgNVBAgMBVN0YXRlMQ0wCwYDVQQHDARDaXR5
MRUwEwYDVQQKDAxPcmdhbml6YXRpb24xEjAQBgNVBAMMCWxvY2FsaG9zdDAeFw0y
NTA5MTUyMjAzMzRaFw0yNjA5MTUyMjAzMzRaMFcxCzAJBgNVBAYTAlVTMQ4wDAYD
VQQIDAVTdGF0ZTENMAsGA1UEBwwEQ2l0eTEVMBMGA1UECgwMT3JnYW5pemF0aW9u
MRIwEAYDVQQDDAlsb2NhbGhvc3QwggIiMA0GCSqGSIb3DQEBAQUAA4ICDwAwggIK
AoICAQC9ckdMj2cVu0yIE2c2zDtum85NK3/WTjV9lqeLA7/dd6Ct+xzYjIDWOcF+
Myp3r91jlaSljzwwV3Nh4HLY9atrWxzX/59UPmt1B7N2GZIr3iPMUZ6VzBOMNfq0
ED1sumuQ0KSO7UbFfjBQg2ZjrcX93dtQvTDcyiUCqE6QnVZfLG6oq5gzZILYCCME
pG9AVX3SpEYpJFr/FwqWtpjiNz2mK9Qfwcg9F2uTS2pH2lb+UupskTCnoATxmh0E
NhhiXlowlmWDA3LWRSHKIGUiCVN/MvrONQuZ0XiWa2u4R476G4CdPdvLy8YHvCpz
FV/mDlbnLb2H65JKlTKRPcTiWQxuWI6nkC86BO4rTtEbT8vchxj7rCtvRHsmsvP+
VkvkdLC1qliB35ltQ995zSGjXAKOrbGK6mZEpE8ux0OL0aD7psTH+1JI+k/M7xJo
VwITmGhfVVHZI64pRpanBIQSycSn/2Bb2qA9ZQeWVBOd6fSraTFVdngFAQwXMxyk
T0/4lleRlyOJ/GJrvJoIcqWZ4/thLN7nDzpkvgOthrJm7yloe9JRB6EUDIMP4n7e
IvDvdqhgmlDaJYSsLOUKm6DufFYfCIu+dB9fiEtJpW65gxD4j8OfXrU6UoF+t2f6
TxBWpUOh2al5nKKTc+XzxkTfNlPvmOyvJcDnKsdhJ0/0UmEmGQIDAQABo1MwUTAd
BgNVHQ4EFgQUJ86Tc8X1FElTwLUmv9eF6WPiCXAwHwYDVR0jBBgwFoAUJ86Tc8X1
FElTwLUmv9eF6WPiCXAwDwYDVR0TAQH/BAUwAwEB/zANBgkqhkiG9w0BAQsFAAOC
AgEAr48yA8VtUgmdpkBQ+HSfpyF3ATl+YvHc8caZg6Y7CeLtznArw/OLKRDr5TjK
XaT74/07t1tHC3xp/e8aD+CRouDSz/vLJ0nOStxahjglePdDuZOHuYCh1ofKcJZD
IHQNyR7bxOcI4q22vGJHwI3TtEPiN5RuHkX235GTJCcv+V7Qz0ueF/oF8mgowT1e
SB31dOHppf8phv2pApUriWO5yde8Md2sfGijcdx/jMF2ZbDgO1Ch+ubDJT0Slg57
j1gtapPVX36hk1e57SwkmUWbDKXHbmEMnYhZ3l1TJKLHz/WF/vQrq4jWThB9BnBR
bPfu43lFOH2K+Ft04NZo8uo0Ass+XH+4s+/wZPoeLT/Le9QtZCHukLWiFsbi7tGp
9MJYH3oe6P/L2Xzt5Z2HllvJ9JkWf0JsghwMn47hVTWMLSLvDieV/uhRl9ZRs8z3
6biaxeVwo+eH3S90NbqBV7KYIj9gSbETPIYfJemkq3ualXE3LG2dPJjt9SsYTfOH
oxPbzHJe2u9jb45nCfF2t9Bwp3b5QRQ5A5zUDgB2QtAkPVX+TxMhyUu4jWhnh7p0
hTqvM3TDNXGQiJbtqviUOOGG4lxJ1ZvpTotjyi0pW4I77FskjivAUUjBMhAHjnkf
3wwAp8pn7k4aDPkNSH1aAVm8/V/9zXrHlWdpRMK0IuHE/PY=
-----END CERTIFICATE-----
`

const KEY = `-----BEGIN PRIVATE KEY-----
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
gOP3No5xa4S0eRSLUnBMjTEMCAKvhA==
-----END PRIVATE KEY-----
`

const proxy = httpProxy
  .createProxyServer({
    target: `http://${TARGET_HOST}:${TARGET_PORT}`,
    changeOrigin: true,
  })
  .on('error', (err, _req, res) => {
    console.error('Proxy error:', err.message)
    if (res && !res.headersSent) {
      res.writeHead(502, { 'Content-Type': 'application/json' })
      res.end(
        JSON.stringify({
          error: 'Bad Gateway',
          message: err.message,
        }),
      )
    }
  })

const server = https.createServer(
  {
    key: KEY,
    cert: CERT,
  },
  (req, res) => {
    proxy.web(req, res)
  },
)

server.listen(PROXY_PORT, () => {
  console.log(`ðŸ”’ HTTPS Proxy started successfully`)
  console.log(`   Listening on: https://localhost:${PROXY_PORT}`)
  console.log(`   Proxying to:  http://${TARGET_HOST}:${TARGET_PORT}`)
})
